#!/usr/bin/env perl

# Pragmas.
use strict;
use warnings;

# Modules.
use PYX::Parser;

# Tags, that are simple.
our @tags = ('meta', 'link', 'br', 'hr', 'img', 'input', 'option');

# Debug.
our $debug = 0;

# Stack.
our @stack;

# Arguments.
if ($#ARGV < 0) {
	print "Usage: $0 [filename] [-]\n";
	print "\tfilename\tprocess on filename\n";
	print "\t-\t\tprocess on stdin\n";
	exit 1;
}

# PYX::Parser object.
my $pyx_parser = PYX::Parser->new(
	'start_tag' => \&_start_tag,
	'end_tag' => \&_end_tag,
	'data' => \&_data,
	'output_rewrite' => 1,
);

# Parse from stdin.
if ($ARGV[0] eq '-') {
	$pyx_parser->parse_handler(\*STDIN);

# Parse file.
} else {
	$pyx_parser->parse_file($ARGV[0]);
}

# Process start tag.
sub _start_tag {
	my $obj = shift;
	my $tag = shift;
	_single();
	print "push: " if $debug;	
	push @stack, $tag;
	print "$tag\n" if $debug;
	print $obj->{'line'}, "\n";
}

# Process end tag.
sub _end_tag {
	my $obj = shift;
	_single();
	print "pop: " if $debug;
	my $x = pop @stack;
	print "$x\n" if $debug;
	print $obj->{'line'}, "\n";
}

# Process data.
sub _data {
	my $obj = shift;
	_single();
	print $obj->{'line'}, "\n";
}

# Process end of single.
sub _single {
	my $tag = $stack[-1];
	if ($tag && grep(/^$tag$/, @tags)) {
		print ')'.$tag."\n";
		print "pop: " if $debug;
		my $x = pop @stack;
		print "$x\n" if $debug;
	}
}
